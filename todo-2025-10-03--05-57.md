# TODO: Update bubble subcommand to use latest story file timestamp

Created: 2025-10-03--05-57

## DETAILED TECHNICAL SPECIFICATION

### Files to Modify
1. `/home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5` - Update bubble subcommand logic
2. `/usr/local/bin/icmwriper-5` - Copy updated script to make it globally available

### Changes Required

#### 1. Modify bubble subcommand handler in `/home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5`

**Current code (lines 75-103):**
```bash
elif [ "$1" = "bubble" ]; then
    # Bubble subcommand handler
    # Store bubble name
    BUBBLE_NAME="$2"

    # Check if source file exists
    if [ ! -f "$BUBBLE_NAME" ]; then
        echo "Error: File '$BUBBLE_NAME' does not exist."
        exit 1
    fi

    # Generate timestamp
    TIMESTAMP=$(date +"%Y-%m-%d--%H-%M")

    # Define target filename
    TARGET_FILE="icm-bubble-$TIMESTAMP.md"

    # Copy file
    if ! cp "$BUBBLE_NAME" "$TARGET_FILE"; then
        echo "Error: Failed to copy '$BUBBLE_NAME' to '$TARGET_FILE'."
        exit 1
    fi

    # Replace the story reference with the new bubble filename
    sed -i "s/@icm-story-[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}--[0-9]\{2\}-[0-9]\{2\}\.md/@$TARGET_FILE/g" "$TARGET_FILE"

    # Success message
    echo "Success: Copied '$BUBBLE_NAME' to '$TARGET_FILE' and updated story reference."
    exit 0
```

**New code:**
```bash
elif [ "$1" = "bubble" ]; then
    # Bubble subcommand handler
    # Store bubble name
    BUBBLE_NAME="$2"

    # Check if source file exists
    if [ ! -f "$BUBBLE_NAME" ]; then
        echo "Error: File '$BUBBLE_NAME' does not exist."
        exit 1
    fi

    # Find the latest icm-story-*.md file
    LATEST_STORY=$(ls -t icm-story-*.md 2>/dev/null | head -1)

    # Check if any story file exists
    if [ -z "$LATEST_STORY" ]; then
        echo "Error: No icm-story-*.md files found in current directory."
        exit 1
    fi

    # Extract timestamp from the latest story filename
    # Remove "icm-story-" prefix and ".md" suffix
    TIMESTAMP="${LATEST_STORY#icm-story-}"
    TIMESTAMP="${TIMESTAMP%.md}"

    # Define target filename
    TARGET_FILE="icm-bubble-$TIMESTAMP.md"

    # Copy file
    if ! cp "$BUBBLE_NAME" "$TARGET_FILE"; then
        echo "Error: Failed to copy '$BUBBLE_NAME' to '$TARGET_FILE'."
        exit 1
    fi

    # Replace the story reference with the latest story filename
    sed -i "s/@icm-story-[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}--[0-9]\{2\}-[0-9]\{2\}\.md/@$LATEST_STORY/g" "$TARGET_FILE"

    # Success message
    echo "Success: Copied '$BUBBLE_NAME' to '$TARGET_FILE' and updated story reference to '$LATEST_STORY'."
    exit 0
```

**Key changes:**
- Lines 86-93: Add logic to find latest story file and extract timestamp
- Line 96: Use extracted timestamp instead of current time
- Line 105: Replace with `@$LATEST_STORY` instead of `@$TARGET_FILE`
- Line 108: Update success message to show which story file was referenced

#### 2. Copy updated script to `/usr/local/bin/`

After modifying the local script, copy it to `/usr/local/bin/icmwriper-5` to make both `story` and `bubble` commands available globally.

Command: `sudo cp /home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5 /usr/local/bin/icmwriper-5`

### Implementation Logic

The updated `bubble` subcommand will:
1. Accept a `<bubble-name>` parameter
2. Validate that the source file exists
3. Find the latest `icm-story-*.md` file using `ls -t` (sorted by modification time, newest first)
4. Check if any story file was found (handle empty result)
5. Extract timestamp from story filename using bash parameter expansion:
   - `${LATEST_STORY#icm-story-}` removes `icm-story-` prefix
   - `${TIMESTAMP%.md}` removes `.md` suffix
6. Create target filename as `icm-bubble-<extracted-timestamp>.md`
7. Copy the source file to the target filename
8. Use `sed` to replace `@icm-story-YYYY-MM-DD--HH-MM.md` with `@<latest-story-filename>`
9. Output success message showing which story file was referenced

---

## IMPLEMENTATION CHECKLIST:

- [ ] 1. Edit `/home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5` bubble subcommand to find latest story file and extract its timestamp
- [ ] 2. Edit `/home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5` bubble subcommand to use extracted timestamp for target filename
- [ ] 3. Edit `/home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5` bubble subcommand to replace story reference with latest story filename
- [ ] 4. Copy updated script to `/usr/local/bin/icmwriper-5`

---

## REVIEW SECTION
(To be completed during EXECUTE mode)
