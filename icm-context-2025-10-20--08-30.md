# ICMwRIPER-5 Project Context

## Executive Summary

**Project Name**: ICMwRIPER-5 Command-Line Tool

**Current Status**: All three platforms now support Next.js web app project generation and bubble-only template file creation - All platforms have 5 subcommands each with full feature parity

**Purpose**: A cross-platform CLI tool for managing ICMwRIPER-5 methodology projects, providing specialized project initialization and timestamped file management for story-bubble iteration pairs

**Platforms**:
- **Ubuntu**: WSL2 Ubuntu 24.04 on Windows 11
- **macOS**: macOS Sequoia 15.6.1 with iTerm2 and zsh
- **Windows**: Windows 11 with PowerShell 7.5.3

**Script Locations**:
- Ubuntu: `/home/wzb/OOR/katas/ICMwRIPER-5/icm4u`
- macOS: `/Users/binwu/OOR-local/katas/ICMwRIPER-5/icm4m`
- Windows: `C:\Users\wubin\OOR\katas\ICMwRIPER-5\icm4p.ps1`

**Quick Capabilities**:
- Generate HTML data dashboard projects with template and data files from GitHub
- Generate Next.js web app projects with template files from GitHub (all platforms)
- Create matched story-bubble file pairs in a single command with automatic reference updates
- Create timestamped bubble log files for session tracking
- Create timestamped bubble-only files with template content for direct AI prompting
- Full cross-platform compatibility across Ubuntu, macOS, and Windows PowerShell

## Business Requirements Implemented

### Combined Story-Bubble Creation

**Requirement**: Users need a streamlined way to create both story and bubble files simultaneously with guaranteed timestamp consistency

**Solution**: `icm4u snb <source-story-file>` command (SNB = Story aNd Bubble)

**What it does**:
- Copies the specified story file with current timestamp
- Copies `icm-bubble-template.md` with the same timestamp
- Updates story references in the bubble file

**Key difference from separate commands**: Both files share identical timestamp, ensuring perfect pairing

**Workflow improvement**: Reduces from 2 commands to 1 command

### Bubble-Only File Creation

**Requirement**: Users need a quick way to create timestamped bubble files with pre-populated template content for scenarios where no corresponding story file is needed

**Solution**: `icm4u bo` command (BO = Bubble Only)

**What it does**:
- Creates a timestamped file with format `icm-bubble-only-<timestamp>.md`
- Copies content from `icm-bubble-only-template.md` into the new file
- No dependency on story files

**Key difference from 'b' command**: The 'b' command creates an empty file named `bubble-<timestamp>.md`, while 'bo' creates a file with template content named `icm-bubble-only-<timestamp>.md`

**Use case**: When users want to create standalone prompts that can be directly copied to AI tools without a corresponding story file

### HTML Data Dashboard Project Generation

**Requirement**: Users need to quickly bootstrap new data dashboard projects with both ICMwRIPER-5 templates and data files

**Solution**: `icm4u create-html-data-dashboard <project-name>` command

**What it provides**: Downloads 6 files from GitHub repository:
- 4 standard template files (same as `create` command)
- 2 additional data dashboard files from subdirectory

**Files downloaded**:
- `icm-bubble-template.md`
- `icm-story-template.md`
- `icmwriper-5.md`
- `README.md` (renamed to `icmwriper-5-README.md`)
- `first-80-rows-agentic_ai_performance_dataset_20250622.xlsx`
- `.gitignore`

**Key behavior**: All files placed in project root directory (flattened structure)

**Use case**: Specialized for Python/HTML/CSS/JavaScript data visualization projects

### Next.js Web App Project Generation

**Requirement**: Users need to quickly bootstrap new Next.js web application projects with ICMwRIPER-5 templates

**Solution**: `icm4u create-nextjs-web-app <project-name>` command (all platforms)

**What it provides**: Downloads 5 files from GitHub repository:
- 2 standard template files (core protocol and README)
- 3 additional Next.js-specific files from subdirectory

**Files downloaded**:
- `icmwriper-5.md`
- `README.md` (renamed to `icmwriper-5-README.md`)
- `icm-bubble-template-for-nextjs-web-app.md`
- `icm-story-template-for-nextjs-web-app.md`
- `.gitignore` (Next.js-specific)

**Key behavior**: All files placed in project root directory (flattened structure)

**Use case**: Specialized for Next.js/React/TypeScript web application projects

### Automatic Reference Management

**Requirement**: Bubble files must reference their corresponding story files

**Solution**: The `snb` command automatically updates story file references using pattern matching

**Pattern matching**: Supports both numeric timestamps (e.g., `2025-10-03--21-43`) and template placeholders (e.g., `yyyy-mm-dd--hh-mm`)

**Example**: Replaces `@icm-story-yyyy-mm-dd--hh-mm.md` with `@icm-story-2025-10-03--22-01.md`

## Technical Architecture

### Technology Stack

**Languages**:
- Bash shell script (`#!/usr/bin/env bash`) for Ubuntu and macOS
- PowerShell script (`#!/usr/bin/env pwsh`) for Windows

**Platforms**:
- **Ubuntu**: WSL2 Ubuntu 24.04 on Windows 11
- **macOS**: macOS Sequoia 15.6.1 with iTerm2 and zsh
- **Windows**: Windows 11 with PowerShell 7.5.3

**External dependencies**:
- **Unix/Linux/macOS**: `curl` (for file downloads), `sed` (for text replacement), `date` (for timestamps)
- **Windows PowerShell**: `Invoke-WebRequest` (for file downloads), `-replace` operator (for text replacement), `Get-Date` (for timestamps)

**Platform-specific considerations**:
- **Ubuntu**: Uses `sed -i` for in-place editing
- **macOS**: Uses `sed -i '' -E` for in-place editing with extended regex support
- **Windows**: Uses PowerShell `-replace` operator and `Set-Content` for text replacement

**Source repository**: `https://github.com/wubin28/ICMwRIPER-5`

### File Naming Conventions

**Timestamp format**: `yyyy-mm-dd--hh-mm` (e.g., `2025-10-03--22-01`)

**Generation command**: `date +"%Y-%m-%d--%H-%M"`

**Story files**: `icm-story-<timestamp>.md`

**Bubble files**: `icm-bubble-<timestamp>.md`

**Todo files**: `todo-<timestamp>.md` (created during PLAN mode)

### Script Architecture

**Command patterns**:
- Ubuntu: `icm4u <subcommand> <argument>`
- macOS: `icm4m <subcommand> <argument>`
- Windows: `pwsh -File icm4p.ps1 <subcommand> <argument>`

**Routing structure**: `if-elif-else` subcommand dispatcher

**Supported subcommands**:
- Ubuntu: `b`, `bo`, `snb`, `create-html-data-dashboard`, `create-nextjs-web-app`
- macOS: `b`, `bo`, `snb`, `create-html-data-dashboard`, `create-nextjs-web-app`
- Windows PowerShell: `b`, `bo`, `snb`, `create-html-data-dashboard`, `create-nextjs-web-app`

**Error handling**: All operations validate inputs and provide descriptive error messages with exit code 1

**Success handling**: All operations output confirmation messages with exit code 0

**Cross-platform compatibility**: All three scripts implement identical functionality with platform-specific optimizations

### Key Design Decisions

#### Decision 1: Automatic story reference updates

**Rationale**: Bubble files reference their corresponding story files; manual updates are error-prone

**Implementation**: Uses `sed` with enhanced regex pattern to replace old story references with the latest/new story filename

**Enhanced pattern**: `s/@icm-story-\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}--[0-9]\{2\}-[0-9]\{2\}\|yyyy-mm-dd--hh-mm\)\.md/@$TARGET/g`

**Pattern supports**: Both numeric timestamps AND template placeholder format

#### Decision 2: Download from GitHub raw URLs

**Rationale**: Ensures users always get the latest template files without manual copying

**Implementation**: Uses `curl` to fetch from `https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main/`

**Error handling**: Cleans up partial directories if any download fails

#### Decision 3: SNB command uses inline implementation

**Rationale**: Maintains consistency with existing code structure; allows precise timestamp control

**Alternatives considered**: Function extraction or recursive command chaining

**Why inline was chosen**:
- Self-contained logic, easy to understand
- No dependencies between subcommands
- Allows both files to use identical timestamp
- Matches existing pattern where each subcommand is independent

## Bug Fix History

### SNB Subcommand Bug Fix (2025-10-20)

**User Story**:
- **As a**: icm4u的用户
- **I want**: 修复当第一次执行"icm4u snb"子命令时出现的bug
- **So that**: 当第一次执行"icm4u snb"子命令时当前目录并不存在"icm-bubble-template.md"文件时，icm4u会自动把当前目录以"icm-bubble-template"开头的文件作为bubble的默认模板内容

**Acceptance Criteria**:
- **Given**: 用户刚执行完"icm4u create-nextjs-web-app <project-name>"命令并成功创建项目
- **When**: 用户在运行"icm4u snb icm-story-template.md"命令后
- **Then**: icm4u会自动把当前目录以"icm-bubble-template"开头的文件作为bubble的默认模板内容

**Issue**: When first executing the "snb" subcommand after creating a project with `create-nextjs-web-app`, the current directory might not contain "icm-bubble-template.md" but instead contains files like "icm-bubble-template-for-nextjs-web-app.md".

**Root Cause**: The original implementation hardcoded the template filename as "icm-bubble-template.md" instead of dynamically searching for files starting with "icm-bubble-template".

**Fix Applied**: Modified all three platform scripts (icm4u, icm4m, icm4p.ps1) to:
1. Use `find` command (Unix) or `Get-ChildItem` (PowerShell) to search for files starting with "icm-bubble-template"
2. Sort the results and use the first matching file as the template
3. Update success messages to reflect the actual template file used

**Impact**: The snb subcommand now works correctly in all project types, automatically adapting to the specific bubble template file available in the current directory.

**Files Modified**:
- `/home/ben/OOR/katas/ICMwRIPER-5/icm4u` (already fixed)
- `/home/ben/OOR/katas/ICMwRIPER-5/icm4m` (fixed in this update)
- `/home/ben/OOR/katas/ICMwRIPER-5/icm4p.ps1` (fixed in this update)

**Verification**: All three scripts have been syntax-verified and maintain functional parity across platforms.