#!/usr/bin/env bash

# Special handling for single-argument commands
if [ $# -eq 1 ]; then
    if [ "$1" = "bubble-log" ]; then
        # Bubble-log subcommand handler
        # Generate timestamp
        TIMESTAMP=$(date +"%Y-%m-%d--%H-%M")

        # Define target filename
        TARGET_FILE="bubble-$TIMESTAMP.md"

        # Create empty file
        if ! touch "$TARGET_FILE"; then
            echo "Error: Failed to create '$TARGET_FILE'."
            exit 1
        fi

        # Success message
        echo "Success: Created empty file '$TARGET_FILE'."
        exit 0
    else
        echo "Error: Unknown single-argument command '$1'."
        echo "Usage: icmwriper-5-for-ubuntu {bubble-log | snb <story-name> | generate-html-data-dashboard <project-name> | generate-nextjs-web-app <project-name>}"
        exit 1
    fi
fi

# Argument count validation
if [ $# -ne 2 ]; then
    echo "Usage: icmwriper-5-for-ubuntu {bubble-log | snb <story-name> | generate-html-data-dashboard <project-name> | generate-nextjs-web-app <project-name>}"
    exit 1
fi

# Subcommand routing
if [ "$1" = "snb" ]; then
    # SNB (Story aNd Bubble) subcommand handler
    # Store story name
    STORY_NAME="$2"

    # Check if source story file exists
    if [ ! -f "$STORY_NAME" ]; then
        echo "Error: File '$STORY_NAME' does not exist."
        exit 1
    fi

    # Check if bubble template exists
    if [ ! -f "icm-bubble-template.md" ]; then
        echo "Error: File 'icm-bubble-template.md' does not exist."
        exit 1
    fi

    # Generate timestamp (will be used for both files)
    TIMESTAMP=$(date +"%Y-%m-%d--%H-%M")

    # Define target filenames
    STORY_TARGET="icm-story-$TIMESTAMP.md"
    BUBBLE_TARGET="icm-bubble-$TIMESTAMP.md"

    # Copy story file
    if ! cp "$STORY_NAME" "$STORY_TARGET"; then
        echo "Error: Failed to copy '$STORY_NAME' to '$STORY_TARGET'."
        exit 1
    fi

    # Copy bubble file
    if ! cp "icm-bubble-template.md" "$BUBBLE_TARGET"; then
        echo "Error: Failed to copy 'icm-bubble-template.md' to '$BUBBLE_TARGET'."
        # Cleanup: remove the story file that was already created
        rm -f "$STORY_TARGET"
        exit 1
    fi

    # Replace the story reference with the newly created story filename
    # Match both numeric timestamps and the template placeholder format
    sed -i "s/@icm-story-\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}--[0-9]\{2\}-[0-9]\{2\}\|yyyy-mm-dd--hh-mm\)\.md/@$STORY_TARGET/g" "$BUBBLE_TARGET"

    # Success message
    echo "Success: Copied '$STORY_NAME' to '$STORY_TARGET'."
    echo "Success: Copied 'icm-bubble-template.md' to '$BUBBLE_TARGET' and updated story reference to '$STORY_TARGET'."
    exit 0

elif [ "$1" = "generate-html-data-dashboard" ]; then
    # Generate HTML Data Dashboard subcommand handler
    # Store project name
    PROJECT_NAME="$2"

    # Directory existence check
    if [ -d "$PROJECT_NAME" ]; then
        echo "Error: Directory '$PROJECT_NAME' already exists."
        exit 1
    fi

    # GitHub repository configuration
    GITHUB_RAW_URL="https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main"

    # Define files to download with their paths
    # Root files (4 files)
    ROOT_FILES=("icm-bubble-template.md" "icm-story-template.md" "icmwriper-5.md" "README.md")

    # Subdirectory files (2 files)
    SUBDIR_FILES=("for-html-data-dashboard/first-80-rows-agentic_ai_performance_dataset_20250622.xlsx" "for-html-data-dashboard/.gitignore")

    # Create project directory
    if ! mkdir "$PROJECT_NAME"; then
        echo "Error: Failed to create directory '$PROJECT_NAME'."
        exit 1
    fi

    # Download root files
    for filename in "${ROOT_FILES[@]}"; do
        url="$GITHUB_RAW_URL/$filename"
        if ! curl -f -sS -o "$PROJECT_NAME/$filename" "$url"; then
            echo "Error: Failed to download $filename from GitHub. Please check your internet connection and repository availability."
            rm -rf "$PROJECT_NAME"
            exit 1
        fi
    done

    # Download subdirectory files
    for filepath in "${SUBDIR_FILES[@]}"; do
        # Extract just the filename for the target
        filename=$(basename "$filepath")
        url="$GITHUB_RAW_URL/$filepath"
        if ! curl -f -sS -o "$PROJECT_NAME/$filename" "$url"; then
            echo "Error: Failed to download $filepath from GitHub. Please check your internet connection and repository availability."
            rm -rf "$PROJECT_NAME"
            exit 1
        fi
    done

    # Rename README.md
    mv "$PROJECT_NAME/README.md" "$PROJECT_NAME/icmwriper-5-README.md"

    # Success message
    echo "Success: Project '$PROJECT_NAME' created with ICMwRIPER-5 template files and HTML data dashboard resources."
    exit 0

elif [ "$1" = "generate-nextjs-web-app" ]; then
    # Generate Next.js Web App subcommand handler
    # Store project name
    PROJECT_NAME="$2"

    # Directory existence check
    if [ -d "$PROJECT_NAME" ]; then
        echo "Error: Directory '$PROJECT_NAME' already exists."
        exit 1
    fi

    # GitHub repository configuration
    GITHUB_RAW_URL="https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main"

    # Define files to download with their paths
    # Root files (2 files)
    ROOT_FILES=("icmwriper-5.md" "README.md")

    # Subdirectory files (3 files)
    SUBDIR_FILES=("for-nextjs-web-app/icm-bubble-template-for-nextjs-web-app.md" "for-nextjs-web-app/icm-story-template-for-nextjs-web-app.md" "for-nextjs-web-app/.gitignore")

    # Create project directory
    if ! mkdir "$PROJECT_NAME"; then
        echo "Error: Failed to create directory '$PROJECT_NAME'."
        exit 1
    fi

    # Download root files
    for filename in "${ROOT_FILES[@]}"; do
        url="$GITHUB_RAW_URL/$filename"
        if ! curl -f -sS -o "$PROJECT_NAME/$filename" "$url"; then
            echo "Error: Failed to download $filename from GitHub. Please check your internet connection and repository availability."
            rm -rf "$PROJECT_NAME"
            exit 1
        fi
    done

    # Download subdirectory files
    for filepath in "${SUBDIR_FILES[@]}"; do
        # Extract just the filename for the target
        filename=$(basename "$filepath")
        url="$GITHUB_RAW_URL/$filepath"
        if ! curl -f -sS -o "$PROJECT_NAME/$filename" "$url"; then
            echo "Error: Failed to download $filepath from GitHub. Please check your internet connection and repository availability."
            rm -rf "$PROJECT_NAME"
            exit 1
        fi
    done

    # Rename README.md
    mv "$PROJECT_NAME/README.md" "$PROJECT_NAME/icmwriper-5-README.md"

    # Success message
    echo "Success: Project '$PROJECT_NAME' created with ICMwRIPER-5 template files and Next.js web app resources."
    exit 0
else
    echo "Error: Unknown command '$1'. Supported commands: 'bubble-log', 'snb', 'generate-html-data-dashboard', 'generate-nextjs-web-app'."
    exit 1
fi
