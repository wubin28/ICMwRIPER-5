# TODO: 为 icm4u 添加 -gitee 参数支持

**创建时间**: 2025-10-26--21-38
**目标文件**: `/home/ben/OOR/katas/ICMwRIPER-5/icm4u`
**业务需求**: 支持使用 -gitee 参数从 Gitee 仓库获取模板文件

---

## 技术规格

### 新增功能
- 命令语法: `icm4u create-html-data-dashboard [-gitee] <project-name>`
- 命令语法: `icm4u create-nextjs-web-app [-gitee] <project-name>`
- Gitee URL: `https://gitee.com/wubin28/ICMwRIPER-5/raw/main`
- GitHub URL (默认): `https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main`

### 修改范围
1. 参数数量验证逻辑 (line 53-54)
2. Usage 错误消息 (line 47, 54)
3. create-html-data-dashboard 子命令 (lines 110-164)
4. create-nextjs-web-app 子命令 (lines 166-220)

---

## IMPLEMENTATION CHECKLIST

### 基础修改
- [ ] 1. 修改 icm4u:53 - 参数验证允许 2 或 3 个参数: `[ $# -ne 2 ] && [ $# -ne 3 ]`
- [ ] 2. 修改 icm4u:54 - 更新 Usage 消息包含 `[-gitee]` 参数
- [ ] 3. 修改 icm4u:47 - 更新单参数错误的 Usage 消息包含 `[-gitee]` 参数

### create-html-data-dashboard 子命令修改
- [ ] 4. 修改 icm4u:110-122 - 添加参数解析逻辑（-gitee 标志判断，设置 REPO_URL/PROJECT_NAME/REPO_SOURCE）
- [ ] 5. 修改 icm4u:139 - 替换 `$GITHUB_RAW_URL` 为 `$REPO_URL` (root files)
- [ ] 6. 修改 icm4u:141 - 错误消息 "from GitHub" 改为 "from $REPO_SOURCE" (root files)
- [ ] 7. 修改 icm4u:151 - 替换 `$GITHUB_RAW_URL` 为 `$REPO_URL` (subdir files)
- [ ] 8. 修改 icm4u:153 - 错误消息 "from GitHub" 改为 "from $REPO_SOURCE" (subdir files)
- [ ] 9. 修改 icm4u:163 - 成功消息改为 "...downloaded from $REPO_SOURCE)."

### create-nextjs-web-app 子命令修改
- [ ] 10. 修改 icm4u:166-178 - 添加参数解析逻辑（-gitee 标志判断，设置 REPO_URL/PROJECT_NAME/REPO_SOURCE）
- [ ] 11. 修改 icm4u:195 - 替换 `$GITHUB_RAW_URL` 为 `$REPO_URL` (root files)
- [ ] 12. 修改 icm4u:197 - 错误消息 "from GitHub" 改为 "from $REPO_SOURCE" (root files)
- [ ] 13. 修改 icm4u:207 - 替换 `$GITHUB_RAW_URL` 为 `$REPO_URL` (subdir files)
- [ ] 14. 修改 icm4u:209 - 错误消息 "from GitHub" 改为 "from $REPO_SOURCE" (subdir files)
- [ ] 15. 修改 icm4u:219 - 成功消息改为 "...downloaded from $REPO_SOURCE)."

### 功能测试
- [ ] 16. 测试: `icm4u create-html-data-dashboard test-gh-html` - 验证 GitHub 默认行为
- [ ] 17. 测试: `icm4u create-html-data-dashboard -gitee test-gitee-html` - 验证 Gitee 功能
- [ ] 18. 测试: `icm4u create-nextjs-web-app test-gh-nextjs` - 验证 GitHub（Next.js）
- [ ] 19. 测试: `icm4u create-nextjs-web-app -gitee test-gitee-nextjs` - 验证 Gitee（Next.js）
- [ ] 20. 测试: `icm4u create-html-data-dashboard -gitee` - 验证缺少项目名错误处理
- [ ] 21. 测试: `icm4u d` 和 `icm4u bo` - 验证现有命令不受影响

### 清理和总结
- [ ] 22. 清理所有测试创建的项目目录
- [ ] 23. 在本文件末尾添加审查总结部分

---

## 详细修改说明

### 修改 1-3: 参数验证和 Usage 消息

**icm4u:53** 当前:
```bash
if [ $# -ne 2 ]; then
```
修改为:
```bash
if [ $# -ne 2 ] && [ $# -ne 3 ]; then
```

**icm4u:54 和 icm4u:47** Usage 消息更新为:
```bash
echo "Usage: icmwriper-5-for-ubuntu {d | bo | snb <story-name> | create-html-data-dashboard [-gitee] <project-name> | create-nextjs-web-app [-gitee] <project-name>}"
```

---

### 修改 4: create-html-data-dashboard 参数解析

**icm4u:110-122** 替换为:
```bash
elif [ "$1" = "create-html-data-dashboard" ]; then
    # Generate HTML Data Dashboard subcommand handler

    # Parse arguments to determine repository source and project name
    if [ $# -eq 3 ] && [ "$2" = "-gitee" ]; then
        # Use Gitee repository
        REPO_URL="https://gitee.com/wubin28/ICMwRIPER-5/raw/main"
        PROJECT_NAME="$3"
        REPO_SOURCE="Gitee"
    elif [ $# -eq 2 ]; then
        # Use GitHub repository (default)
        REPO_URL="https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main"
        PROJECT_NAME="$2"
        REPO_SOURCE="GitHub"
    else
        # Invalid arguments
        if [ $# -eq 3 ] && [ "$2" != "-gitee" ]; then
            echo "Error: Invalid flag '$2'. Expected '-gitee'."
        elif [ $# -eq 2 ] && [ "$2" = "-gitee" ]; then
            echo "Error: Missing project name after '-gitee' flag."
        else
            echo "Error: Invalid arguments for create-html-data-dashboard."
        fi
        echo "Usage: icmwriper-5-for-ubuntu create-html-data-dashboard [-gitee] <project-name>"
        exit 1
    fi

    # Directory existence check
    if [ -d "$PROJECT_NAME" ]; then
        echo "Error: Directory '$PROJECT_NAME' already exists."
        exit 1
    fi
```

---

### 修改 5-9: create-html-data-dashboard URL 和消息

- **line 139**: `url="$GITHUB_RAW_URL/$filename"` → `url="$REPO_URL/$filename"`
- **line 141**: `"from GitHub"` → `"from $REPO_SOURCE"`
- **line 151**: `url="$GITHUB_RAW_URL/$filepath"` → `url="$REPO_URL/$filepath"`
- **line 153**: `"from GitHub"` → `"from $REPO_SOURCE"`
- **line 163**: `"(7 files downloaded)."` → `"(7 files downloaded from $REPO_SOURCE)."`

---

### 修改 10: create-nextjs-web-app 参数解析

**icm4u:166-178** 替换为:
```bash
elif [ "$1" = "create-nextjs-web-app" ]; then
    # Generate Next.js Web App subcommand handler

    # Parse arguments to determine repository source and project name
    if [ $# -eq 3 ] && [ "$2" = "-gitee" ]; then
        # Use Gitee repository
        REPO_URL="https://gitee.com/wubin28/ICMwRIPER-5/raw/main"
        PROJECT_NAME="$3"
        REPO_SOURCE="Gitee"
    elif [ $# -eq 2 ]; then
        # Use GitHub repository (default)
        REPO_URL="https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main"
        PROJECT_NAME="$2"
        REPO_SOURCE="GitHub"
    else
        # Invalid arguments
        if [ $# -eq 3 ] && [ "$2" != "-gitee" ]; then
            echo "Error: Invalid flag '$2'. Expected '-gitee'."
        elif [ $# -eq 2 ] && [ "$2" = "-gitee" ]; then
            echo "Error: Missing project name after '-gitee' flag."
        else
            echo "Error: Invalid arguments for create-nextjs-web-app."
        fi
        echo "Usage: icmwriper-5-for-ubuntu create-nextjs-web-app [-gitee] <project-name>"
        exit 1
    fi

    # Directory existence check
    if [ -d "$PROJECT_NAME" ]; then
        echo "Error: Directory '$PROJECT_NAME' already exists."
        exit 1
    fi
```

---

### 修改 11-15: create-nextjs-web-app URL 和消息

- **line 195**: `url="$GITHUB_RAW_URL/$filename"` → `url="$REPO_URL/$filename"`
- **line 197**: `"from GitHub"` → `"from $REPO_SOURCE"`
- **line 207**: `url="$GITHUB_RAW_URL/$filepath"` → `url="$REPO_URL/$filepath"`
- **line 209**: `"from GitHub"` → `"from $REPO_SOURCE"`
- **line 219**: `"(6 files downloaded)."` → `"(6 files downloaded from $REPO_SOURCE)."`

---

## 测试预期结果

### 测试 16: GitHub 默认 (HTML Dashboard)
```bash
icm4u create-html-data-dashboard test-gh-html
```
**预期输出**:
```
Success: Project 'test-gh-html' created with ICMwRIPER-5 template files and HTML data dashboard resources (7 files downloaded from GitHub).
```

### 测试 17: Gitee 新功能 (HTML Dashboard)
```bash
icm4u create-html-data-dashboard -gitee test-gitee-html
```
**预期输出**:
```
Success: Project 'test-gitee-html' created with ICMwRIPER-5 template files and HTML data dashboard resources (7 files downloaded from Gitee).
```

### 测试 18: GitHub 默认 (Next.js)
```bash
icm4u create-nextjs-web-app test-gh-nextjs
```
**预期输出**:
```
Success: Project 'test-gh-nextjs' created with ICMwRIPER-5 template files and Next.js web app resources (6 files downloaded from GitHub).
```

### 测试 19: Gitee 新功能 (Next.js)
```bash
icm4u create-nextjs-web-app -gitee test-gitee-nextjs
```
**预期输出**:
```
Success: Project 'test-gitee-nextjs' created with ICMwRIPER-5 template files and Next.js web app resources (6 files downloaded from Gitee).
```

### 测试 20: 错误处理 - 缺少项目名
```bash
icm4u create-html-data-dashboard -gitee
```
**预期输出**:
```
Error: Missing project name after '-gitee' flag.
Usage: icmwriper-5-for-ubuntu create-html-data-dashboard [-gitee] <project-name>
```

### 测试 21: 现有功能不受影响
```bash
icm4u d
icm4u bo
```
**预期**: 正常创建 dialog 和 bubble-only 文件

---

## 审查总结

### 实施记录
- **修改日期**: 2025-10-26
- **修改人**: Claude (AI Assistant)
- **实际修改内容**:
  - ✅ 修改 icm4u 文件，添加 -gitee 参数支持
  - ✅ 更新参数验证逻辑，允许 2 或 3 个参数
  - ✅ 更新所有 Usage 错误消息
  - ✅ 为 create-html-data-dashboard 添加参数解析逻辑
  - ✅ 为 create-nextjs-web-app 添加参数解析逻辑
  - ✅ 替换所有硬编码的 GitHub URL 为动态 REPO_URL
  - ✅ 更新所有成功和错误消息，显示仓库来源

### 代码修改细节
1. **参数验证** (icm4u:53): 从 `[ $# -ne 2 ]` 改为 `[ $# -ne 2 ] && [ $# -ne 3 ]`
2. **Usage 消息** (icm4u:47, 54): 添加 `[-gitee]` 参数说明
3. **create-html-data-dashboard** (icm4u:110-183):
   - 添加 25 行参数解析代码
   - 修改 URL 变量为 REPO_URL
   - 修改成功/错误消息包含 REPO_SOURCE
4. **create-nextjs-web-app** (icm4u:185-258):
   - 添加 25 行参数解析代码
   - 修改 URL 变量为 REPO_URL
   - 修改成功/错误消息包含 REPO_SOURCE

### 发现的问题和解决方案
**问题**: 初始计划中的参数解析逻辑有错误
- **描述**: `elif [ $# -eq 2 ]` 会匹配所有 2 参数情况，导致 `-gitee` 无第三参数时被当作项目名
- **解决**: 将条件改为 `elif [ $# -eq 2 ] && [ "$2" != "-gitee" ]`，确保只有非 `-gitee` 的 2 参数情况才使用 GitHub 默认行为

### 测试结果
所有测试 100% 通过：

| 测试项 | 命令 | 结果 |
|--------|------|------|
| GitHub 默认 (HTML) | `icm4u create-html-data-dashboard test-gh-html` | ✅ 通过 - 显示 "from GitHub" |
| Gitee 新功能 (HTML) | `icm4u create-html-data-dashboard -gitee test-gitee-html` | ✅ 通过 - 显示 "from Gitee" |
| GitHub 默认 (Next.js) | `icm4u create-nextjs-web-app test-gh-nextjs` | ✅ 通过 - 显示 "from GitHub" |
| Gitee 新功能 (Next.js) | `icm4u create-nextjs-web-app -gitee test-gitee-nextjs` | ✅ 通过 - 显示 "from Gitee" |
| 错误处理 | `icm4u create-html-data-dashboard -gitee` | ✅ 通过 - 显示错误消息 |
| 向后兼容 | `icm4u d` 和 `icm4u bo` | ✅ 通过 - 现有功能正常 |

### 最终状态
- **代码审查状态**: ✅ 完成
- **是否符合计划**: ✅ 完全符合（除一处逻辑修正）
- **向后兼容性**: ✅ 完全兼容，现有功能不受影响
- **功能完整性**: ✅ 所有需求功能已实现
- **测试覆盖**: ✅ 100% 通过率

### 备注
1. 实施过程中发现并修复了计划中的一个参数解析逻辑错误
2. 修复后的逻辑更加健壮，正确处理所有边界情况
3. 所有测试用例均按预期通过
4. 终端输出清晰显示仓库来源（GitHub 或 Gitee）
5. 代码变更最小化，仅修改必要部分
6. 保持了与原有代码风格的一致性

---

**执行完成时间**: 2025-10-26--22-01
**执行状态**: ✅ 成功完成
