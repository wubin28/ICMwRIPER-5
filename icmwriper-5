#!/usr/bin/env bash

# Argument count validation
if [ $# -ne 2 ]; then
    echo "Usage: icmwriper-5 {generate <project-name> | story <story-name> | bubble <bubble-name>}"
    exit 1
fi

# Subcommand routing
if [ "$1" = "generate" ]; then
    # Generate subcommand handler
    # Store project name
    PROJECT_NAME="$2"

    # Directory existence check
    if [ -d "$PROJECT_NAME" ]; then
        echo "Error: Directory '$PROJECT_NAME' already exists."
        exit 1
    fi

    # GitHub repository configuration
    GITHUB_RAW_URL="https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main"
    FILES=("icm-bubble-template.md" "icm-story-template.md" "icmwriper-5.md" "README.md")

    # Create project directory
    if ! mkdir "$PROJECT_NAME"; then
        echo "Error: Failed to create directory '$PROJECT_NAME'."
        exit 1
    fi

    # Download files
    for filename in "${FILES[@]}"; do
        url="$GITHUB_RAW_URL/$filename"
        if ! curl -f -sS -o "$PROJECT_NAME/$filename" "$url"; then
            echo "Error: Failed to download $filename from GitHub. Please check your internet connection and repository availability."
            rm -rf "$PROJECT_NAME"
            exit 1
        fi
    done

    # Rename README.md
    mv "$PROJECT_NAME/README.md" "$PROJECT_NAME/icmwriper-5-README.md"

    # Success message
    echo "Success: Project '$PROJECT_NAME' created with ICMwRIPER-5 template files."
    exit 0

elif [ "$1" = "story" ]; then
    # Story subcommand handler
    # Store story name
    STORY_NAME="$2"

    # Check if source file exists
    if [ ! -f "$STORY_NAME" ]; then
        echo "Error: File '$STORY_NAME' does not exist."
        exit 1
    fi

    # Generate timestamp
    TIMESTAMP=$(date +"%Y-%m-%d--%H-%M")

    # Define target filename
    TARGET_FILE="icm-story-$TIMESTAMP.md"

    # Copy file
    if ! cp "$STORY_NAME" "$TARGET_FILE"; then
        echo "Error: Failed to copy '$STORY_NAME' to '$TARGET_FILE'."
        exit 1
    fi

    # Success message
    echo "Success: Copied '$STORY_NAME' to '$TARGET_FILE'."
    exit 0

elif [ "$1" = "bubble" ]; then
    # Bubble subcommand handler
    # Store bubble name
    BUBBLE_NAME="$2"

    # Check if source file exists
    if [ ! -f "$BUBBLE_NAME" ]; then
        echo "Error: File '$BUBBLE_NAME' does not exist."
        exit 1
    fi

    # Generate timestamp
    TIMESTAMP=$(date +"%Y-%m-%d--%H-%M")

    # Define target filename
    TARGET_FILE="icm-bubble-$TIMESTAMP.md"

    # Copy file
    if ! cp "$BUBBLE_NAME" "$TARGET_FILE"; then
        echo "Error: Failed to copy '$BUBBLE_NAME' to '$TARGET_FILE'."
        exit 1
    fi

    # Replace the story reference with the new bubble filename
    sed -i "s/@icm-story-[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}--[0-9]\{2\}-[0-9]\{2\}\.md/@$TARGET_FILE/g" "$TARGET_FILE"

    # Success message
    echo "Success: Copied '$BUBBLE_NAME' to '$TARGET_FILE' and updated story reference."
    exit 0
else
    echo "Error: Unknown command '$1'. Supported commands: 'generate', 'story', 'bubble'."
    exit 1
fi
