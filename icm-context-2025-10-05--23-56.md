# ICMwRIPER-5 Project Context

## Executive Summary

**Project Name**: ICMwRIPER-5 Command-Line Tool

**Current Status**: Dual platform implementation completed - Ubuntu and macOS versions fully functional

**Purpose**: A bash-based CLI tool for managing ICMwRIPER-5 methodology projects, providing project initialization and timestamped file management for story-bubble iteration pairs

**Platforms**:
- **Ubuntu**: WSL2 Ubuntu 24.04 on Windows 11
- **macOS**: macOS Sequoia 15.6.1 with iTerm2 and zsh

**Script Locations**:
- Ubuntu: `/home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5-for-ubuntu`
- macOS: `/Users/binwu/OOR-local/katas/ICMwRIPER-5/icmwriper-5-for-macos`

**Quick Capabilities**:
- Generate new projects with template files from GitHub
- Create timestamped story files
- Create timestamped bubble files with automatic story reference updates
- Create matched story-bubble file pairs in a single command
- **NEW**: Full cross-platform compatibility between Ubuntu and macOS

## Business Requirements Implemented

### Project Initialization

**Requirement**: Users need to quickly bootstrap new ICMwRIPER-5 projects

**Solution**: `icmwriper-5-for-ubuntu generate <project-name>` command

**What it provides**: Downloads 4 template files from GitHub repository

**Files downloaded**:
- `icm-bubble-template.md`
- `icm-story-template.md`
- `icmwriper-5.md`
- `README.md` (renamed to `icmwriper-5-README.md`)

### Iteration Management

**Requirement**: Users need to create timestamped story-bubble file pairs for each development iteration

**Story creation**: `icmwriper-5-for-ubuntu story <story-name>` creates `icm-story-<timestamp>.md`

**Bubble creation**: `icmwriper-5-for-ubuntu bubble <bubble-name>` creates `icm-bubble-<timestamp>.md`

**Key behavior**: Bubble files automatically use the timestamp from the most recent story file (not current system time)

### Combined Story-Bubble Creation

**Requirement**: Users need a streamlined way to create both story and bubble files simultaneously with guaranteed timestamp consistency

**Solution**: `icmwriper-5-for-ubuntu snb <story-name>` command (SNB = Story aNd Bubble)

**What it does**:
- Copies the specified story file with current timestamp
- Copies `icm-bubble-template.md` with the same timestamp
- Updates story references in the bubble file

**Key difference from separate commands**: Both files share identical timestamp, ensuring perfect pairing

**Workflow improvement**: Reduces from 2 commands to 1 command

### Automatic Reference Management

**Requirement**: Bubble files must reference their corresponding story files

**Solution**: Both `bubble` and `snb` commands automatically update story file references using pattern matching

**Pattern matching**: Supports both numeric timestamps (e.g., `2025-10-03--21-43`) and template placeholders (e.g., `yyyy-mm-dd--hh-mm`)

**Example**: Replaces `@icm-story-yyyy-mm-dd--hh-mm.md` with `@icm-story-2025-10-03--22-01.md`

## Technical Architecture

### Technology Stack

**Language**: Bash shell script (`#!/usr/bin/env bash`)

**Platforms**:
- **Ubuntu**: WSL2 Ubuntu 24.04 on Windows 11
- **macOS**: macOS Sequoia 15.6.1 with iTerm2 and zsh

**External dependencies**: `curl` (for file downloads), `sed` (for text replacement), `date` (for timestamps)

**Platform-specific considerations**:
- **Ubuntu**: Uses `sed -i` for in-place editing
- **macOS**: Uses `sed -i '' -E` for in-place editing with extended regex support

**Source repository**: `https://github.com/wubin28/ICMwRIPER-5`

### File Naming Conventions

**Timestamp format**: `yyyy-mm-dd--hh-mm` (e.g., `2025-10-03--22-01`)

**Generation command**: `date +"%Y-%m-%d--%H-%M"`

**Story files**: `icm-story-<timestamp>.md`

**Bubble files**: `icm-bubble-<timestamp>.md`

**Todo files**: `todo-<timestamp>.md` (created during PLAN mode)

### Script Architecture

**Command patterns**:
- Ubuntu: `icmwriper-5-for-ubuntu <subcommand> <argument>`
- macOS: `icmwriper-5-for-macos <subcommand> <argument>`

**Routing structure**: `if-elif-else` subcommand dispatcher

**Supported subcommands**: `generate`, `story`, `bubble`, `snb`

**Error handling**: All operations validate inputs and provide descriptive error messages with exit code 1

**Success handling**: All operations output confirmation messages with exit code 0

**Cross-platform compatibility**: Both scripts implement identical functionality with platform-specific optimizations

### Key Design Decisions

#### Decision 1: Bubble timestamp matches story timestamp

**Rationale**: Story and bubble files form conceptual pairs for each iteration

**Implementation**: The `bubble` command finds the latest `icm-story-*.md` file using `ls -t` and extracts its timestamp

**Benefit**: File pairs are easily identifiable by matching timestamps

#### Decision 2: Automatic story reference updates

**Rationale**: Bubble files reference their corresponding story files; manual updates are error-prone

**Implementation**: Uses `sed` with enhanced regex pattern to replace old story references with the latest/new story filename

**Enhanced pattern**: `s/@icm-story-\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}--[0-9]\{2\}-[0-9]\{2\}\|yyyy-mm-dd--hh-mm\)\.md/@$TARGET/g`

**Pattern supports**: Both numeric timestamps AND template placeholder format

#### Decision 3: Download from GitHub raw URLs

**Rationale**: Ensures users always get the latest template files without manual copying

**Implementation**: Uses `curl` to fetch from `https://raw.githubusercontent.com/wubin28/ICMwRIPER-5/main/`

**Error handling**: Cleans up partial directories if any download fails

#### Decision 4: SNB command uses inline implementation

**Rationale**: Maintains consistency with existing code structure; allows precise timestamp control

**Alternatives considered**: Function extraction or recursive command chaining

**Why inline was chosen**:
- Self-contained logic, easy to understand
- No dependencies between subcommands
- Allows both files to use identical timestamp
- Matches existing pattern where each subcommand is independent

#### Decision 5: SNB hardcodes bubble template filename

**Rationale**: Simplifies command syntax; 99% use case is the template file

**Implementation**: Always uses `icm-bubble-template.md`

**User only specifies**: The story source file

**Trade-off**: Less flexibility, but clearer user experience

#### Decision 6: SNB cleanup strategy on failure

**Rationale**: Avoid orphaned story files if bubble creation fails

**Implementation**: If bubble file copy fails, the already-created story file is removed with `rm -f`

**Benefit**: Maintains consistency; either both files are created or neither

#### Decision 7: Cross-platform implementation strategy

**Rationale**: Support both Ubuntu and macOS environments while maintaining code consistency

**Implementation**: Separate scripts with minimal platform-specific modifications

**Key differences**:
- Ubuntu: `sed -i "pattern" file`
- macOS: `sed -i '' -E "pattern" file` (requires empty string after -i and extended regex)

**Benefits**:
- Platform-native user experience
- Identical functionality across platforms
- Easy maintenance and testing

## Implementation Details

Both platform scripts implement four subcommands with consistent error handling and validation patterns:

**Ubuntu script**: `icmwriper-5-for-ubuntu` (167 lines)
**macOS script**: `icmwriper-5-for-macos` (167 lines with platform-specific modifications)

### generate Subcommand

**Functionality**:
- Creates new project directory
- Downloads 4 template files from GitHub
- Renames `README.md` to `icmwriper-5-README.md`

**Implementation approach**:
1. Validate that project directory doesn't already exist
2. Create directory with `mkdir`
3. Loop through file array, downloading each with `curl -f -sS -o`
4. If any download fails, remove entire directory and exit
5. Rename README file with `mv`
6. Output success message

**Key validation**:
- Directory existence check before creation
- Curl failure detection with cleanup
- Exactly 2 arguments required

### story Subcommand

**Functionality**:
- Copies a source story file
- Renames it with current timestamp
- Appends `.md` extension

**Implementation approach**:
1. Validate source file exists
2. Generate timestamp using `date +"%Y-%m-%d--%H-%M"`
3. Construct target filename: `icm-story-$TIMESTAMP.md`
4. Copy file with `cp`
5. Output success message

**Key validation**:
- Source file existence check
- Copy operation error handling

### bubble Subcommand

**Functionality**:
- Copies a source bubble file
- Renames it using the timestamp from the latest story file
- Updates story file references within the copied file

**Implementation approach**:
1. Validate source file exists
2. Find latest story file: `ls -t icm-story-*.md 2>/dev/null | head -1`
3. Validate that at least one story file exists
4. Extract timestamp using bash parameter expansion:
   - Remove prefix: `${LATEST_STORY#icm-story-}`
   - Remove suffix: `${TIMESTAMP%.md}`
5. Construct target filename: `icm-bubble-$TIMESTAMP.md`
6. Copy file with `cp`
7. Replace story references using enhanced sed pattern (supports both numeric timestamps and `yyyy-mm-dd--hh-mm` placeholder)
8. Output success message showing which story file was referenced

**Key validation**:
- Source file existence check
- Story file existence check (must have at least one)
- Copy operation error handling

**Key technical details**:
- Uses `ls -t` to sort by modification time (newest first)
- Uses bash parameter expansion for efficient string manipulation
- Enhanced sed regex matches both numeric timestamps and template placeholder format

### snb Subcommand

**Functionality**:
- Creates matched story-bubble file pair with identical timestamp
- Copies specified story file with current timestamp
- Copies `icm-bubble-template.md` with the same timestamp
- Updates story references in the bubble file

**Implementation approach**:
1. Validate source story file exists
2. Validate that `icm-bubble-template.md` exists
3. Generate single timestamp using `date +"%Y-%m-%d--%H-%M"` (used for both files)
4. Define both target filenames:
   - `STORY_TARGET="icm-story-$TIMESTAMP.md"`
   - `BUBBLE_TARGET="icm-bubble-$TIMESTAMP.md"`
5. Copy story file with `cp`
6. Copy bubble template file with `cp`
   - If this fails, cleanup the story file with `rm -f` and exit
7. Replace story references using enhanced sed pattern
8. Output two success messages (one for story, one for bubble)

**Key validation**:
- Source story file existence check
- Bubble template file existence check
- Story copy error handling
- Bubble copy error handling with cleanup

**Key technical details**:
- Single timestamp generation ensures perfect pairing
- Cleanup strategy prevents orphaned files
- Sed pattern identical to bubble command
- Hardcoded bubble template filename for simplicity

**Error handling flow**:
- If story file doesn't exist → exit with error, no files created
- If template doesn't exist → exit with error, no files created
- If story copy fails → exit with error, no files created
- If bubble copy fails → remove story file, exit with error

## Usage Examples

### Example 1: Creating a new project

**Ubuntu**:
```bash
$ icmwriper-5-for-ubuntu generate my-kata-project
Success: Project 'my-kata-project' created with ICMwRIPER-5 template files.
```

**macOS**:
```bash
$ ./icmwriper-5-for-macos generate my-kata-project
Success: Project 'my-kata-project' created with ICMwRIPER-5 template files.
```

### Example 2: Creating a story file

**Ubuntu**:
```bash
$ icmwriper-5-for-ubuntu story icm-story-template.md
Success: Copied 'icm-story-template.md' to 'icm-story-2025-10-03--22-01.md'.
```

**macOS**:
```bash
$ ./icmwriper-5-for-macos story icm-story-template.md
Success: Copied 'icm-story-template.md' to 'icm-story-2025-10-05--23-32.md'.
```

### Example 3: Creating a bubble file

**Ubuntu**:
```bash
$ icmwriper-5-for-ubuntu bubble icm-bubble-template.md
Success: Copied 'icm-bubble-template.md' to 'icm-bubble-2025-10-03--22-01.md' and updated story reference to 'icm-story-2025-10-03--22-01.md'.
```

**macOS**:
```bash
$ ./icmwriper-5-for-macos bubble icm-bubble-template.md
Success: Copied 'icm-bubble-template.md' to 'icm-bubble-2025-10-05--23-32.md' and updated story reference to 'icm-story-2025-10-05--23-32.md'.
```

### Example 4: Creating matched story-bubble pair

**Ubuntu**:
```bash
$ icmwriper-5-for-ubuntu snb icm-story-template.md
Success: Copied 'icm-story-template.md' to 'icm-story-2025-10-03--22-01.md'.
Success: Copied 'icm-bubble-template.md' to 'icm-bubble-2025-10-03--22-01.md' and updated story reference to 'icm-story-2025-10-03--22-01.md'.
```

**macOS**:
```bash
$ ./icmwriper-5-for-macos snb icm-story-template.md
Success: Copied 'icm-story-template.md' to 'icm-story-2025-10-05--23-33.md'.
Success: Copied 'icm-bubble-template.md' to 'icm-bubble-2025-10-05--23-33.md' and updated story reference to 'icm-story-2025-10-05--23-33.md'.
```

## Context for AI Tools

This context was updated after completing the macOS conversion project (2025-10-05). Both Ubuntu and macOS scripts are fully functional and tested. When continuing development:

**Script locations**:
- Ubuntu: `/home/wzb/OOR/katas/ICMwRIPER-5/icmwriper-5-for-ubuntu`
- macOS: `/Users/binwu/OOR-local/katas/ICMwRIPER-5/icmwriper-5-for-macos`

**Development guidelines**:
- Follow the ICMwRIPER-5 methodology documented in `icmwriper-5.md`
- Maintain the existing error handling patterns (validate inputs, provide clear error messages, exit with code 1 on failure)
- Keep timestamp format consistent: `yyyy-mm-dd--hh-mm`
- Test all file operations with proper error handling and cleanup
- For cross-platform changes, update both scripts maintaining platform-specific optimizations
- The enhanced sed pattern supports both numeric timestamps and the `yyyy-mm-dd--hh-mm` template placeholder

**Platform-specific considerations**:
- Ubuntu uses basic sed syntax: `sed -i "pattern" file`
- macOS requires extended regex: `sed -i '' -E "pattern" file`

The methodology requires AI tools to work in 5 distinct modes: RESEARCH, INNOVATE, PLAN, EXECUTE, and REVIEW. Always declare your current mode at the start of each response.

## Latest Development (2025-10-05)

**Requirement**: Convert Ubuntu script to macOS compatibility while preserving all functionality

**Implementation completed**:
- Created `icmwriper-5-for-macos` from `icmwriper-5-for-ubuntu`
- Updated usage message to reference correct script name
- Modified sed commands for macOS compatibility:
  - Added `-E` flag for extended regex support
  - Changed quantifier syntax from `\{n\}` to `{n}`
  - Maintained `-i ''` for in-place editing
- All 4 subcommands tested and verified functional on macOS Sequoia 15.6.1
- Story reference replacement confirmed working in bubble files

**Key technical challenge resolved**: macOS sed doesn't support basic regex quantifiers `\{n\}` by default, requiring extended regex mode and syntax updates.

## Context Metadata

**Created**: 2025-10-03 22:01

**Updated**: 2025-10-05 23:56

**Iterations completed**: 6 (including macOS conversion)

**Script versions**:
- Ubuntu: 167 lines, 4 subcommands
- macOS: 167 lines, 4 subcommands (with platform-specific modifications)

**Last updated**: After completing macOS conversion and cross-platform testing

**Previous context**: `icm-context-2025-10-03--22-01.md`

**Current story-bubble pair**: `icm-story-2025-10-05--22-48.md` / `icm-bubble-2025-10-05--22-48.md`

**Repository**: `https://github.com/wubin28/ICMwRIPER-5`

**Status**: Both Ubuntu and macOS implementations fully functional and tested
